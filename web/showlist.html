<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Show todo list</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd" crossorigin="anonymous">
    <script src="js/jweb.js"></script>
    <script>$(function(){$('#navbar').load('navbar.html');});</script>

    <script>
        function populateList(listID) {
            console.log('1');
            $.ajax({
                url: '/todolist/get-list',
                method: 'GET',
                success: function (response) {
                    var list = document.getElementById(listID);
                    while (list.firstChild) {
                        list.removeChild(list.firstChild);
                    }
                    var items = response['items'];
                    if (items.length === 0) {
                        var empty = document.createElement('li');
                        empty.className = 'list-group-item list-group-item-action p-2';
                        empty.innerHTML = '<div class="w-100"><h3>Your to-do list is empty!</h3><h4>Time to go outside and touch grass</h4></div>';
                        list.appendChild(empty);
                    }
                    for (var i = 0; i < items.length; ++i) {
                        if (i > 0) {
                            var gap = document.createElement('li');
                            gap.className = 'list-group-item bg-dark-subtle p-1';
                            list.appendChild(gap);
                        }
                        var li = document.createElement('li');
                        statusFormat = '';
                        if (items[i]['status'] === 'done') statusFormat = "text-decoration-line-through";
                        li.className = 'list-group-item list-group-item-action p-2 has-popover ' + statusFormat;
                        li.setAttribute('id', items[i]['id']);
                        li.setAttribute('tabindex', '0');
                        li.setAttribute('onclick', 'setCurrentItem("'+items[i]['id']+'")');
                        li.innerHTML = '<div class="d-flex w-100 justify-content-between border-bottom">\n' +
                            '<h5 class="mb-1 text-muted">' + items[i]['title'] + '</h5>\n' +
                            '<small class="text-muted">' + items[i]['deadline'] + '</small>\n' +
                            '</div>\n' +
                            '<div class="mt-2">' + items[i]['description'] + '</div>';
                        list.appendChild(li);
                    }
                },
                error: function (xhr, status, error) {
                    alert(status + ':' + error);
                }
            });
        }

        var currentItem = '';

        function setCurrentItem(itemId)
        {
            currentItem = itemId;
        }

        function addItem()
        {
            $.ajax({
                url: "/todolist/add-item",
                type: "post",
                data: $('#addItemForm').serialize(),
                success: function() {
                    showToast('itemAdded');
                    populateList('todoList');
                },
                error: function (xhr, status) {
                    alert(status + ' ' + xhr.status + ': ' + xhr.responseText);
                }
            });
        }

        function deleteItem(itemId)
        {
            $.ajax({
                url: "/todolist/remove-item",
                type: "get",
                data: {"id": itemId},
                success: function() {
                    showToast('itemRemoved');
                    populateList('todoList');
                },
                error: function (xhr, status) {
                    alert(status + ' ' + xhr.status + ': ' + xhr.responseText);
                }
            });
        }

        function editItem(itemId)
        {
            alert('edit '+itemId);
        }

        function updateItemStatus(itemId, status)
        {
            $.ajax({
                url: "/todolist/update-item-status",
                type: "post",
                data: {"id": itemId, "status": status},
                success: function() {
                    populateList('todoList');
                },
                error: function (xhr, status) {
                    alert(status + ' ' + xhr.status + ': ' + xhr.responseText);
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            makeToast('itemAddedContainer', 'itemAdded', '', 'To-do list item added', 500);
            makeToast('itemRemovedContainer', 'itemRemoved', '', 'To-do list item removed', 500);
            setCurrentItem('');
            new bootstrap.Popover(document.body, {
                selector: '.has-popover',
                html: true,
                content: $('[data-name="button-bar"]'),
                placement: 'top',
                trigger: 'focus'
            });
            populateList('todoList');
        });


    </script>

</head>
<body>

<div id="navbar"></div>
<div id="navbar_padding" style="height: 63px"></div>

<div class="container p-3">
    <h2 class="text-muted">Your to-do list</h2>
    <div class="bg-dark-subtle p-3">
        <ul class="list-group list-group-flush" id="todoList">
        </ul>
        <button type="button" class="btn btn-outline-primary rounded-pill mt-3 w-100 p-0 fw-bold" style="font-size: x-large" data-bs-toggle="modal" data-bs-target="#addItemModal">+</button>
        </div>
    </div>

    <div class="modal fade" id="addItemModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Add item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <form id="addItemForm" method="post">
                        <div class="container p-3 bg-body-secondary">
                            <div>
                                <label class="form-label mb-1" for="title">Title</label>
                                <input type="text" class="form-control" id="title" name="title" placeholder="Title">
                            </div>
                            <div class="mt-2">
                                <label class="form-label mb-1" for="deadline">Deadline</label>
                                <input type="datetime-local" class="form-control" id="deadline" name="deadline" placeholder="Deadline">
                            </div>
                            <div class="mt-2">
                                <label class="form-label mb-1" for="description">Description</label>
                                <textarea class="form-control" rows="3" id="description" name="description" placeholder="Description"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="btn-group d-flex justify-content-end w-100">
                        <button type="button" style="max-width:120px" class="btn btn-secondary rounded-pill me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" onclick="addItem()" style="max-width:120px" class="btn btn-primary rounded-pill" data-bs-dismiss="modal">Add Item</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="itemAddedContainer" class="toast-container position-absolute p-3 top-50 start-50 translate-middle"></div>
    <div id="itemRemovedContainer" class="toast-container position-absolute p-3 top-50 start-50 translate-middle"></div>

    <div hidden >
        <div data-name="button-bar">
            <a role="button" onclick="editItem(currentItem)" class="btn btn-outline-primary me-1"><i class="bi-pencil"></i></a>
            <a role="button" onclick="updateItemStatus(currentItem, 'done')" class="btn btn-outline-primary me-1"><i class="bi-check2-circle"></i></a>
            <a role="button" onclick="updateItemStatus(currentItem, 'open')" class="btn btn-outline-primary me-1"><i class="bi-circle"></i></a>
            <a role="button" onclick="deleteItem(currentItem)" class="btn btn-outline-primary"><i class="bi-trash"></i></a>
        </div>
    </div>

</body>
</html>